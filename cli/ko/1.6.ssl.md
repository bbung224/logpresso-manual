## 1.6. SSL 인증서 생성 ##

OpenSSL을 이용해 SHA256 암호화 인증서를 생성합니다.

### 1.6.1. 루트 CA 인증서 생성 ###

키를 생성합니다.

~~~
$ openssl genrsa -out rootCA.key 2048
Generating RSA private key, 2048 bit long modulus
~~~

생성된 키로 루트 CA 인증서를 생성합니다. 예문에서 인증서 만기일은 3650일 입니다.
~~~
$ openssl req -x509 -sha256 -new -nodes -key rootCA.key -days 3650 -out rootCA.crt
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:
State or Province Name (full name) []:
Locality Name (eg, city) [Default City]:
Organization Name (eg, company) [Default Company Ltd]:
Organizational Unit Name (eg, section) []:
Common Name (eg, your name or your server's hostname) []:
Email Address []:
~~~

### 1.6.2. HOST 인증서 생성 ###

HOST 인증서에 사용할 키를 생성합니다. HOST 인증서와 SENTRY 인증서 모두 이 방법으로 생성할 수 있습니다.

~~~
$ openssl genrsa -out host.key 2048
Generating RSA private key, 2048 bit long modulus
~~~

키를 사용해 CSR 파일을 만듭니다.

~~~
$ openssl req -sha256 -new -key host.key -out host.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:
State or Province Name (full name) []:
Locality Name (eg, city) [Default City]:
Organization Name (eg, company) [Default Company Ltd]:
Organizational Unit Name (eg, section) []:
Common Name (eg, your name or your server's hostname) []:
Email Address []:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
~~~

HOST 키와 CSR과 CA인증서를 이용해 HOST 인증서를 생성합니다. 예문에서 인증서 만기일은 3650일 입니다.

~~~
$ openssl x509 -req -sha256 -in host.csr -CA rootCA.crt -CAkey rootCA.key -CAcreateserial -out host.crt -days 3650
Signature ok
subject=/C=KR/ST=Seoul/L=Gangnam/O=EEDIOM
Getting CA Private Key
~~~

### 1.6.3. HOST 인증서를 pkcs#12 타입으로 변환 ###

HOST 인증서 pkcs#12 타입 변환은 아래와 같이 명령합니다.

~~~
$ openssl pkcs12 -export -in host.crt -certfile rootCA.crt -inkey host.key -out host.pfx
Enter Export Password:
Verifying - Enter Export Password:
~~~

### 1.6.4. CA 인증서를 자바 키스토어(JKS) 타입으로 변환  ###

CA 인증서 jks 타입 변환은 아래와 같이 명령합니다.

~~~
$ keytool -import -trustcacerts -alias ca -file rootCA.crt -keystore CA.jks
키 저장소 비밀번호 입력:
새 비밀번호 다시 입력:

...

이 인증서를 신뢰합니까? [아니오]:  예
인증서가 키 저장소에 추가되었습니다.
~~~

### 1.6.5. 인증서 Keystore 등록 ###

JKS파일과 pfx 파일을 로그프레소 콘솔에서 keystore.register 명령으로 등록합니다. 예문에 있는 12345678 대신 jks 파일과 pfx 파일을 생성할 때 입력한 암호를 입력하면 됩니다.

~~~~
araqne> keystore.register
Description

        register keystore

Arguments

        1. name: the name of the key store (required)
        2. type: the type of the key store. for example, JKS, PKCS12, etc. (required)
        3. file path: the file path of the key store (required)
        4. password: the password of the key store (optional)

araqne> keystore.register testks-ca JKS /home/ssl_test/CA.jks 12345678
[testks-ca] key store registered

araqne> keystore.register testks-host PKCS12 /home/ssl_test/host.pfx 12345678
[testks-host] key store registered
~~~~

keystore.list 명령으로 keystore에 등록된 인증서 목록을 볼 수 있습니다.

~~~~
araqne> keystore.list
Key Stores
-------------
[testks-host] type: PKCS12, path: /home/ssl_test/host.pfx
[testks-ca] type: JKS, path: /home/ssl_test/CA.jks
~~~~

### 1.6.6. HTTPS 설정 ###

SSL 인증서로 HTTPS 포트 설정을 할 수 있습니다. 설정 명령은 아래와 같습니다.

~~~
araqne> httpd.openSsl
Description

        open https server

Arguments

        1. port: bind port (required)
        2. default context: default http context (required)
        3. key alias: JKS keystore name (required)
        4. trust alias: JKS truststore name for client authentication (optional)

araqne> httpd.openSsl 9998 webconsole testks-host
opened https server
~~~

HTTPS 설정 결과는 httpd.bindings 명령어로 확인할 수 있습니다.

~~~
araqne> httpd.bindings
Port Bindings
---------------------
/0.0.0.0:8888, opened, default context: webconsole, idle timeout: 0seconds
/0.0.0.0:9998 (ssl: key testks-host, trust null), opened, default context: webconsole, idle timeout: 0seconds
~~~

